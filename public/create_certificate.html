<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create Certificate</title>
  <link rel="stylesheet" href="create_certificate.css">
</head>
<body>
<div class="page">
  <!-- LEFT PANEL -->
  <div class="left card">
    <h1>Create Certificate</h1>

    <!-- HIDDEN TEMPLATE INPUTS (EXAMPLE) -->
    <input type="hidden" name="template_id" value="template-01">
    <input type="hidden" name="template_version" value="v1">

    <!-- visible, readonly template name -->
    <div class="field">
      <label for="templateName">Template name</label>
      <input id="templateName" name="template_name" type="text"
             value="Sample Professional Development Certificate" />
    </div>

    <!-- NEW VISIBLE INPUTS -->
    <div class="field">
      <label for="recipientName">Recipient name</label>
      <input id="recipientName" type="text" placeholder="John Doe">
    </div>

    <div class="field">
      <label for="courseName">Course</label>
      <input id="courseName" type="text" placeholder="Professional Development Course">
    </div>

    <div class="field">
      <label for="issueDate">Issue date</label>
      <input id="issueDate" type="date">
    </div>

    <div class="field">
      <label for="purposeText">Purpose / description</label>
      <textarea id="purposeText" placeholder="Describe why this certificate is issued"></textarea>
    </div>

    <!-- Fixed Placeholders -->
    <h2>Placeholders</h2>
    <div id="placeholderContainer">
      <div class="field">
        <label for="student_name">Student Name</label>
        <input type="text" id="student_name" placeholder="Enter student name">
      </div>
      <div class="field">
        <label for="workshop_name">Workshop Name</label>
        <input type="text" id="workshop_name" placeholder="Enter workshop name">
      </div>
      <div class="field">
        <label for="duration">Duration</label>
        <input type="text" id="duration" placeholder="Enter duration">
      </div>
      <div class="field">
        <label for="certified_on">Certified On</label>
        <input type="text" id="certified_on" placeholder="Enter date">
      </div>
      <div class="field">
        <label for="certified_by">Certified By</label>
        <input type="text" id="certified_by" placeholder="Enter issuer">
      </div>
    </div>

    <div class="btn-row">
      <button type="button" class="btn-primary" id="previewBtn">Preview</button>
      <button type="button" class="btn-secondary" id="resetBtn">Reset</button>
      <button type="button" class="btn-danger" id="logoutBtn">Logout</button>
    </div>
  </div>


  <!-- RIGHT PANEL -->
  <div class="right">
    <div class="preview-header">
      <h2>Certificate preview</h2>
      <div class="preview-actions">
        <button type="button" id="certSubmit" class="btn-primary">Save certificate</button>
        <button type="button" class="btn-secondary">Export</button>
        <button type="button" class="btn-secondary">Email</button>
      </div>
    </div>

    <div class="certificate-wrapper card" id="cert-wrapper"></div>
  </div>
</div>

<script>
window.addEventListener("load", () => {

  /* -------- CHECK LOGIN ----------- */
  // fetch("../backend/api/auth.php", {
  //   method: "POST",
  //   headers: { "Content-Type": "application/x-www-form-urlencoded" },
  //   body: "action=check"
  // })
  // .then(res => res.json())
  // .then(data => {
  //   if (data.status !== "success") {
  //     alert("User not logged in.");
  //     window.location.href = "./index.html";
  //   }
  // })
  // .catch(() => {
  //   alert("Error connecting to server");
  //   window.location.href = "./index.html";
  // });

  /* ------------ FORM SUBMISSION ----------- */
  document.getElementById("certSubmit").addEventListener("click", (e) => {
    e.preventDefault();

    // BASIC FIELDS
    const t_id = document.getElementById("t_id").value;
    const tname = document.getElementById("t_name").value.trim();
    const orientation = document.querySelector("input[name='orientation']:checked");
    const html_code = document.getElementById("html_code").value.trim();
    const bg_img = document.getElementById("bg_img").value; 
    const opacity = document.getElementById("opacity").value;

    // CERT DATA
    const r_name = document.getElementById("r_name").value.trim();
    const course = document.getElementById("course").value.trim();
    const issue_date = document.getElementById("issue_date").value;
    const purpose = document.getElementById("purpose").value.trim();

    // VALIDATION
    if (!tname) return alert("Certificate template name missing.");
    if (!html_code) return alert("HTML code missing.");
    if (!orientation) return alert("Orientation missing.");
    if (!r_name) return alert("Recipient name required.");
    if (!course) return alert("Course name required.");
    if (!issue_date) return alert("Issue date required.");

    // PLACEHOLDER FIELDS (if any)
    let placeholders = {};
    document.querySelectorAll(".pldr-field").forEach(row => {
      const key = row.querySelector(".pldr-key").value.trim();
      const val = row.querySelector(".pldr-val").value.trim();
      if (key) placeholders[key] = val;
    });

    // PREPARE DATA
    const formData = new FormData();
    formData.append("action", "create");
    formData.append("t_id", t_id);
    formData.append("tname", tname);
    formData.append("orientation", orientation.value);
    formData.append("html_code", html_code);
    formData.append("bg_img", bg_img);
    formData.append("opacity", opacity);

    formData.append("r_name", r_name);
    formData.append("course", course);
    formData.append("issue_date", issue_date);
    formData.append("purpose", purpose);

    // Add placeholder JSON object
    Object.keys(placeholders).forEach(k => {
      formData.append(`pldrs[${k}]`, placeholders[k]);
    });

    // SEND REQUEST
    fetch("../backend/api/certificate.php", {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      if (data.status === "success") {
        window.location.href = "./dashboard.html";
      }
    })
    .catch(err => {
      alert("Server error: " + err.message);
    });

  });

});
</script>

<script src="create_certificate.js"></script>
</body>
</html>
